#!/bin/bash

# https://developer.okta.com/docs/reference/api/authn/#primary-authentication-with-public-application

username=$1
password=$2

answer=$(curl --silent -X POST \
-H "Accept: application/json" \
-H "Content-Type: application/json" \
-d "{
  \"username\": \"${username}\",
  \"password\": \"${password}\",
  \"options\": {
    \"multiOptionalFactorEnroll\": false,
    \"warnBeforePasswordExpired\": false
  }
}" "https://gannett.okta.com/api/v1/authn")

stateToken=$(echo "${answer}" | jq -r .stateToken)
verifyLink=$(echo "${answer}" | jq -r ._embedded.factors[0]._links.verify.href)

# echo "${answer}" | jq .

echo "Sending request to send SMS code"

curl --silent -X POST \
-H "Accept: application/json" \
-H "Content-Type: application/json" \
-d "{
  \"stateToken\": \"${stateToken}\"
}" "${verifyLink}"


echo "Enter SMS code received:"
read smsCode

answer=$(curl --silent -X POST \
-H "Accept: application/json" \
-H "Content-Type: application/json" \
-d "{
  \"stateToken\": \"${stateToken}\",
  \"passCode\": \"${smsCode}\"
}" "${verifyLink}")

expiresAt=$(echo "${answer}" | jq -r .expiresAt)
sessionToken=$(echo "${answer}" | jq -r .sessionToken)
userId=$(echo "${answer}" | jq -r ._embedded.user.id)

# echo "${answer}" | jq .
echo
echo "Token   : ${sessionToken}"
echo "Expires : ${expiresAt}"
echo "User ID : ${userId}"

# From https://stackoverflow.com/questions/36016388/how-can-i-log-into-an-okta-enabled-site-using-curl

# curl -v -X GET "https://gannett.oktapreview.com/login/sessionCookieRedirect?token=${sessionToken}&redirectUrl=http://jira.gannett.com" -c "okta-cookie"
# curl -L -v -X GET "https://gannett.okta.com/home/gannettcoinc_jiradev2_1/0oa8x9tortFtZm8XU1t7/aln8x9wcfaVaJT0sG1t7?fromHome=true&sessiontoken=${sessionToken}" -c "okta-cookie"

# From: https://developer.okta.com/docs/guides/session-cookie/overview/

# curl -c "okta-cookie" -L -v -X GET "https://gannett.okta.com/login/sessionCookieRedirect?checkAccountSetupComplete=true&token=${sessionToken}&redirectUrl=https%3A%2F%2Fgannett.okta.com%2Fuser%2Fnotifications"

#curl -c "okta-cookie" -b "okta-cookie" -L -v -X POST "https://gannett.okta.com/login/sessionCookieRedirect?checkAccountSetupComplete=true&repost=true&token=${sessionToken}&redirectUrl=/app/gannettcoinc_jiradev2_1/exk8x9torsZK6vJdk1t7/sso/saml"

# curl -c "okta-cookie" -L -v -X POST "https://gannett.okta.com/app/gannettcoinc_jiradev2_1/exk8x9torsZK6vJdk1t7/sso/saml&sessionToken=${sessionToken}"
# https://gannett.okta.com/app/gannettcoinc_jiradev2_1/exk8x9torsZK6vJdk1t7/sso/saml

# START HERE:
# curl -L -v -c "okta-cookie" -X POST https://jira.gannett.com/plugins/servlet/samlsso?sessionToken=${sessionToken}
# Then parse the form values and use them with sessionCookieRedirect call

# JSESSIONID
# JiraSDSamlssoLoginV2
# atlassian.xsrf.token
# Cookie: jira.editor.user.mode=wysiwyg; JiraSDSamlssoLoginV2=_5b5fdfdc6a9f92cc69f8e36ddc647c0d%23%23%23YCanty%40gannett.com%23%23%23http%3A%2F%2Fwww.okta.com%2Fexk8x9torsZK6vJdk1t7%23%23%23IIBHB; JSESSIONID=6F3D64987F524A8628A2B1403E052D65; atlassian.xsrf.token=BJ4D-1RTH-YHIR-RS48_c98e66bec8ac8840b13172bade6937d215811a35_lout
