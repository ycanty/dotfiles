#!/bin/bash

function usage() {
    cat<<EOF
    $0 <location_id> <directory>
EOF
}

API_KEY=$(vault read -field=x-api-key secret/sweetiq/listings/apigee/dev-team)
LOC_ID=$1
DIR=$2

if [[ "${DIR}" == "fs" ]]
then
    DIR="api.foursquare.com"
elif [[ "${DIR}" == "gmb" ]]
then
    DIR="business.google.com"
fi

if [[ -z "${LOC_ID}" ]]
then
    usage
    exit 1
fi

if [[ -z "${API_KEY}" ]]
then
    echo "Could not get API_KEY"
    exit 1
fi

if [[ -z "${DIR}" ]]
then
    usage
    exit 1
fi

LISTING_STATUS=$(lsdb-getlistings "${LOC_ID}" "${DIR}" | jq '.[0].listings[0].listing.status')

if [[ -z "${LISTING_STATUS}" ]]
then
    echo "Unable to get listing status"
    exit 1
fi

FIRST_EXT_LISTING_STATUS=$(lsdb-getlistings "${LOC_ID}" "${DIR}" | jq '.[0].listings[0].externalListings[0].status')

if [[ -z "${FIRST_EXT_LISTING_STATUS}" ]]
then
    echo "Unable to get status of first externalListing"
    exit 1
fi


BODY=$(cat <<EOF
{
    "locIds": ["${LOC_ID}"],
	"listingStatus": ${LISTING_STATUS},
	"externalListingStatus": ${FIRST_EXT_LISTING_STATUS},
	"dir":["${DIR}"]
}
EOF
)

echo "Triggering listing transition: ${LOC_ID} ${LISTING_STATUS} ${FIRST_EXT_LISTING_STATUS} ${DIR}"

curl -X POST \
  https://apis.sweetiq.com/listing-service/v1/triggerListingTransition \
  -H "x-api-key: ${API_KEY}" \
  -d "${BODY}" # | jq .
