#!/bin/bash
# Clean the k8s config of contexts we never use

function print_usage() {
    cat<<EOF
Usage: $0 [-h]
EOF
}

function main() {
    # delete existing renamed contexts, except local ones (match: 'desktop')
    kubectl config get-contexts -o name | grep -v '^sweetiq' | grep -v 'desktop' | xargs -n1 kubectl config delete-context

    # delete -user contexts (we only use admin contexts)
    kubectl config get-contexts -o name | grep '^sweetiq-.*-user$' | xargs -n1 kubectl config delete-context
 
    # For 'east' contexts, rename them by removing 'sweetiq-' prefix and `-east-admin` suffix
    kubectl config get-contexts -o name | grep '^sweetiq-.*-east-admin$' | while read NAME
    do
        NEW_NAME=$(echo ${NAME} | sed -E -e 's/sweetiq-(.*)-east-admin$/\1/')
        kubectl config rename-context ${NAME} ${NEW_NAME}
    done

    # For the seldom used 'west' contexts, rename them by removing 'sweetiq-' prefix and `-west-admin` suffix to just `-west`
    kubectl config get-contexts -o name | grep '^sweetiq-.*-west-admin$' | while read NAME
    do
        NEW_NAME=$(echo ${NAME} | sed -E -e 's/sweetiq-(.*)-west-admin$/\1-west/')
        kubectl config rename-context ${NAME} ${NEW_NAME}
    done
}

for cmd in "$@"; do
    case "$cmd" in
        (-h|--help)
            print_usage
            exit 0
            ;;
    esac
done

main "$@"